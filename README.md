# sqsjfr

SQS job feeder.

sqsjfr reads a crontab file and send job messages by the crontab schedules to Amazon SQS FIFO queue.

sqsjfr is designed to cooperate with [sqsjkr](https://github.com/kayac/sqsjkr), but runs as a standalone daemon to send messages to SQS.

## Installation

### binary packages

[Releases](https://github.com/kayac/sqsjfr/releases).

### Homebrew tap

```console
$ brew install kayac/tap/sqsjfr
```

## Usage

```
Usage of sqsjfr:
  -dry-run
    	dry run
  -log-level string
    	log level (default "info")
  -message-template string
    	SQS message template(JSON)
  -queue-url string
    	SQS queue URL
```

Environment variables `SQSJFR_*` are also specify that options. For example, `SQSJFR_QUEUE_URL=https://sqs.ap-northeast-1.amazonaws.com/123456789012/cron.fifo`

```console
$ sqsjfr \
    -queue-url https://sqs.ap-northeast-1.amazonaws.com/123456789012/cron.fifo \
    -message-template message.json \
    example.crontab
2020/10/08 00:43:37.826554 [info] starting up
2020/10/08 00:43:37.828773 [info] loading crontab example.crontab
2020/10/08 00:43:37.828953 [info] [entry:1] registered > * * * * * echo "hello world! $(date)"; sleep 10; echo "goodby world! $(date)"
2020/10/08 00:43:37.828980 [info] [entry:2] registered > * * * * * LANG=C date; sleep 5; LANG=C date
2020/10/08 00:43:37.828994 [info] 2 entries registered
2020/10/08 00:43:37.828999 [info] running daemon
2020/10/08 00:44:03.313092 [info] [entry:2] invoke job {"command":"LANG=C date; sleep 5; LANG=C date","invokedAt":"1602085440"}
2020/10/08 00:44:04.429434 [info] [entry:1] invoke job {"command":"echo \"hello world! $(date)\"; sleep 10; echo \"goodby world! $(date)\"","invokedAt":"1602085440"}
^C2020/10/08 00:44:09.935606 [info] got signal interrupt
2020/10/08 00:44:09.935625 [info] shutting down
2020/10/08 00:44:09.935628 [info] goodby
```

- `-queue-url`: required. must be a FIFO queue.
- `-message-template` SQS message template file. For example,
  ```json
  {
    "command": "{{ .Command | json_escape }}",
    "envs": {
        "HOME": "{{ must_env `HOME` }}",
        "RUNNER": "/usr/local/bin/job-runner"
    }
  }
  ```

- crontab: required. crontab file. Schedule specs are parsed by [github.com/robfig](https://github.com/robfig/cron).
  - Blank lines and leading spaces and tabs are ignored.
  - Lines whose first non-space character is a pound-sign (#) are comments, and  are ignored.
  - Environment variables definition is not allowed. (This is different with Vixie crontab)

## High Availability

sqsjfr can be deployed by multi processes for high availability deployment.

sqsjfr sends SQS messages with [MessageDeduplicationId](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagededuplicationid-property.html) option for SQS FIFO queue. MessageDeduplicationId is generated by a message body and an invoked UNIX timestamp(truncated by a minute).

Therefore even if multi sqsjfr processes send the same messages(has the same body and timestamp) at the same time, FIFO queue delivers one message to consumers.


## LICENSE

MIT
