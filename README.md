# sqsjfr

SQS job feeder.

sqsjfr reads a crontab file and send job messages by the crontab schedules to Amazon SQS FIFO queue.

sqsjfr is designed to cooperate with [sqsjkr](https://github.com/kayac/sqsjkr), but runs as a standalone daemon to send messages to SQS.

## Installation

## Install

### binary packages

[Releases](https://github.com/kayac/sqsjfr/releases).

### Homebrew tap

```console
$ brew install kayac/tap/sqsjfr
```

## Usage

```
Usage of sqsjfr:
  -dry-run
    	dry run
  -log-level string
    	log level (default "info")
  -message-template string
    	SQS message template(JSON)
  -queue-url string
    	SQS queue URL
```

Environment variables `SQSJFR_*` are also specify that options. For example, `SQSJFR_QUEUE_URL=https://sqs.ap-northeast-1.amazonaws.com/123456789012/cron.fifo`

```console
$ sqsjfr \
    -queue-url https://sqs.ap-northeast-1.amazonaws.com/123456789012/cron.fifo \
    -message-template message.json \
    my-crontab-file
```

- `-queue-url`: required. must be a FIFO queue.
- `-message-template` SQS message template file. For example,
  ```json
  {
    "command": "{{ .Command | json_escape }}",
    "envs": {
        "HOME": "{{ must_env `HOME` }}",
        "RUNNER": "/usr/local/bin/job-runner"
    }
  }
  ```

- crontab: required. crontab file. Schedule specs are parsed by [github.com/robfig](https://github.com/robfig/cron).
  - Blank lines and leading spaces and tabs are ignored.
  - Lines whose first non-space character is a pound-sign (#) are comments, and  are ignored.
  - Environment variables definition is not allowed. (This is different with Vixie crontab)

## High Availability

sqsjfr can be deployed by multi processes for high availability deployment.

sqsjfr sends SQS messages with [MessageDeduplicationId](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagededuplicationid-property.html) option for SQS FIFO queue. MessageDeduplicationId is generated by a message body and an invoked UNIX timestamp(truncated by a minute).

Therefore even if multi sqsjfr processes send the same messages(has the same body and timestamp), FIFO queue delivers one message to consumers.


## LICENSE

MIT
